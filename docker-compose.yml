version: '3.8'

services:
  # Search & Discovery Service (GraphQL + REST API)
  search-discovery:
    build:
      context: ./services/search-discovery
      dockerfile: Dockerfile
    container_name: nozama-search-discovery
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3002
      - API_VERSION=v1
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_SEARCH_DB:-nozama-search}
      - BLOCKCHAIN_RPC_URL=${BLOCKCHAIN_RPC_URL:-http://host.docker.internal:8545}
      - PRODUCT_REGISTRY_ADDRESS=${PRODUCT_REGISTRY_ADDRESS}
      - REPUTATION_CONTRACT_ADDRESS=${REPUTATION_CONTRACT_ADDRESS}
      - BLOCKCHAIN_NETWORK=${BLOCKCHAIN_NETWORK:-localhost}
      - IPFS_GATEWAY_URL=${IPFS_GATEWAY_URL:-https://ipfs.io/ipfs/}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000,http://localhost:5173}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE:-20}
      - MAX_PAGE_SIZE=${MAX_PAGE_SIZE:-100}
      - SEARCH_TIMEOUT_MS=${SEARCH_TIMEOUT_MS:-5000}
    networks:
      - nozama-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - search-logs:/app/logs
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Listing Service
  listing-service:
    build:
      context: .
      dockerfile: services/listing-service/Dockerfile
    container_name: nozama-listing-service
    restart: unless-stopped
    ports:
      - "3004:3004"
    env_file:
      - ./services/listing-service/.env
    networks:
      - nozama-network
    extra_hosts:
      - "host.docker.internal:host-gateway"


  # Order Service
  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: nozama-order-service
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3003
      - BLOCKCHAIN_RPC_URL=${BLOCKCHAIN_RPC_URL:-http://host.docker.internal:8545}
      - CHAIN_ID=${CHAIN_ID:-31337}
      - DEPLOYER_PRIVATE_KEY=${DEPLOYER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - LISTING_REGISTRY_ADDRESS=${LISTING_REGISTRY_ADDRESS}
      - ESCROW_CONTRACT_ADDRESS=${ESCROW_CONTRACT_ADDRESS}
      - ORDER_MANAGER_ADDRESS=${ORDER_MANAGER_ADDRESS}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000,http://localhost:5173}
    networks:
      - nozama-network
    volumes:
      - order-logs:/app/logs
      - ./contracts/artifacts:/app/contracts/artifacts:ro
      - ./deployment.json:/app/deployment.json:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - search-discovery

  # Payment Service (Placeholder - To be implemented)
  # payment-service:
  #   build:
  #     context: ./services/payment-service
  #     dockerfile: Dockerfile
  #   container_name: nozama-payment-service
  #   restart: unless-stopped
  #   ports:
  #     - "3005:3005"
  #   environment:
  #     - NODE_ENV=${NODE_ENV:-production}
  #     - PORT=3005
  #     - BLOCKCHAIN_RPC_URL=${BLOCKCHAIN_RPC_URL:-http://host.docker.internal:8545}
  #   networks:
  #     - nozama-network
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"

  # MongoDB Database (shared by identity-reputation and other services)
  mongodb:
    image: mongo:7
    container_name: nozama-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=nozama-identity
    volumes:
      - mongodb_data:/data/db
      - ./services/identity-reputation/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - nozama-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Identity & Reputation Service
  identity-reputation:
    build:
      context: ./services/identity-reputation
      dockerfile: Dockerfile
    container_name: nozama-identity-reputation
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - API_VERSION=v1
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017/nozama-identity}
      - MONGODB_DB_NAME=${MONGODB_IDENTITY_DB:-nozama-identity}
      - BLOCKCHAIN_RPC_URL=${BLOCKCHAIN_RPC_URL:-http://host.docker.internal:8545}
      - REPUTATION_CONTRACT_ADDRESS=${REPUTATION_CONTRACT_ADDRESS}
      - ADMIN_API_KEY=${ADMIN_API_KEY:-admin-secret-key}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-webhook-secret}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000,http://localhost:5173}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
    depends_on:
      - mongodb
    networks:
      - nozama-network
    volumes:
      - identity-logs:/app/logs
      - ./contracts/artifacts:/app/contracts/artifacts:ro
      - ./deployment.json:/app/deployment.json:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/v1/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  nozama-network:
    driver: bridge

volumes:
  search-logs:
    driver: local
  order-logs:
    driver: local
  identity-logs:
    driver: local
  mongodb_data:
    driver: local
  # Add more volumes as services are added
  # listing-logs:
  #   driver: local
  # payment-logs:
  #   driver: local
